# VPS 优化脚本 v2.0 更新说明

## 🎉 重大更新

### v2.0.1 (2025-10-19) - 菜单界面优化

**🎨 界面美化：**

- ✨ 重新设计菜单界面，采用现代化的 UI 风格
- 🎨 添加丰富的图标和颜色标识（emoji + 彩色边框）
- 📊 优化布局，使用分区卡片式设计
- 🔧 修复转义字符显示问题
- 💡 添加功能提示和说明
- ⚡ 改进用户交互体验
- 📝 更新版本号从 v1.0 到 v2.0

**技术改进：**

- 新增颜色变量：PURPLE、CYAN、GRAY、BOLD
- 优化菜单布局代码，提高可读性
- 脚本行数从 1789 行增加到 1799 行

---

### v2.0 (2025-10-19) - 功能大更新

### 作者更名

- 作者从 HAOWEI 更名为 **Kaiki**

### 新增 7 大实用功能模块

---

## ✨ 新增功能详解

### 1️⃣ Docker 环境配置（功能 9）

**功能亮点：**

- 一键安装 Docker Engine + Docker Compose 插件
- 支持多个 Docker 源选择（阿里云、清华、官方）
- 自动配置国内镜像加速（显著提升镜像拉取速度）
- 优化 Docker 日志配置（防止日志占满磁盘）
- 自动配置网络地址池
- 支持添加用户到 docker 组（无需 sudo 运行 docker 命令）
- 自动测试 Docker 安装是否成功

**使用场景：**

- 需要部署容器化应用
- 使用 Docker Compose 编排多容器应用
- 开发测试环境快速部署

**示例流程：**

```
选择Docker源 → 配置镜像加速 → 添加用户到docker组 → 测试安装
```

---

### 2️⃣ Nginx 配置与 SSL 证书（功能 10）

**功能亮点：**

- 一键安装并优化 Nginx 配置
- 集成 acme.sh 自动化 SSL 证书工具
- 支持 3 种证书验证方式：
  - Webroot 模式（推荐，无需停服）
  - Standalone 模式（需要暂停 Web 服务）
  - DNS API 模式（最推荐，全自动）
- 支持主流 DNS 提供商：
  - Cloudflare
  - 阿里云 DNS
  - 腾讯云 DNS
  - 其他（支持 100+DNS 提供商）
- 自动生成 HTTPS 配置文件
- 自动配置 HTTP 到 HTTPS 跳转
- 证书自动续期（无需人工干预）
- 自动在防火墙中开放 80/443 端口

**Nginx 优化项：**

- 启用 Gzip 压缩（减少传输带宽）
- 优化文件缓存（提升响应速度）
- 配置 SSL 安全参数（TLS 1.2/1.3）
- 优化 worker 进程配置
- 隐藏版本号（提升安全性）

**使用场景：**

- 部署网站、博客
- 搭建 API 服务
- 配置反向代理
- 需要 HTTPS 证书

**示例流程：**

```
安装Nginx → 优化配置 → 安装acme.sh → 申请证书 → 安装证书到Nginx
```

---

### 3️⃣ 安装常用工具（功能 11）

**功能亮点：**

- 分类安装，按需选择
- 支持一键安装全部工具
- 支持自定义选择安装

**工具分类：**

**系统监控工具：**

- htop（交互式进程监控）
- iotop（磁盘 IO 监控）
- nload（网络流量监控）
- glances（综合系统监控）

**网络工具：**

- curl、wget（文件下载）
- net-tools（网络配置）
- dnsutils（DNS 查询）
- traceroute（路由跟踪）
- telnet（端口测试）
- nmap（端口扫描）

**编辑器：**

- vim（强大的文本编辑器）
- nano（简单易用的编辑器）

**开发工具：**

- git（版本控制）
- build-essential（编译工具链）
- python3-pip（Python 包管理）

**压缩工具：**

- zip/unzip
- rar/unrar
- p7zip（7z 格式）

**使用场景：**

- 系统监控和调试
- 网络问题排查
- 开发环境搭建
- 文件压缩解压

---

### 4️⃣ 配置自动备份（功能 12）

**功能亮点：**

- 自动备份重要配置文件
- 支持备份网站数据
- 支持 MySQL 数据库备份（需配置密码）
- 自动压缩备份文件
- 定时清理旧备份（防止占满磁盘）
- 可配置备份频率
- 生成详细备份日志

**备份内容：**

- SSH 配置文件
- Nginx 配置文件
- 系统挂载配置
- Systemd 服务配置
- 网站数据（/var/www）
- 数据库（可选）

**备份频率选项：**

- 每天凌晨 2 点
- 每周日凌晨 2 点
- 每月 1 号凌晨 2 点
- 自定义 cron 表达式

**使用场景：**

- 生产环境数据保护
- 配置文件版本管理
- 灾难恢复准备

**生成文件：**

- 备份脚本：`/usr/local/bin/auto_backup.sh`
- 备份目录：`/backup/` (可自定义)
- 备份日志：`/var/log/backup.log`

---

### 5️⃣ 配置系统监控告警（功能 13）

**功能亮点：**

- 监控 CPU 使用率（可设置阈值）
- 监控内存使用率（可设置阈值）
- 监控磁盘使用率（可设置阈值）
- 监控系统负载
- 监控关键服务状态（SSH、Nginx、Docker）
- 定时自动检查（每小时）
- 生成监控日志

**监控项目：**

```
✓ CPU使用率    默认阈值：80%
✓ 内存使用率   默认阈值：80%
✓ 磁盘使用率   默认阈值：85%
✓ 系统负载
✓ 服务状态     SSH、Nginx、Docker等
```

**告警方式：**

- 记录到日志文件
- 可以配合邮件告警（需额外配置）
- 可以配合 Webhook 通知（需额外配置）

**使用场景：**

- 实时掌握服务器状态
- 及时发现资源瓶颈
- 监控关键服务运行状况
- 提前预防故障

**生成文件：**

- 监控脚本：`/usr/local/bin/system_monitor.sh`
- 监控日志：`/var/log/monitor.log`

---

### 6️⃣ 优化 SSH 连接速度（功能 14）

**功能亮点：**

- 禁用 DNS 反向解析（显著提升连接速度）
- 禁用 GSSAPI 认证（减少认证时间）
- 启用 TCP KeepAlive（保持连接稳定）
- 配置客户端保活参数（防止连接超时）

**优化效果：**

- SSH 连接速度提升 50%+
- 减少连接等待时间
- 防止连接意外断开
- 改善使用体验

**使用场景：**

- SSH 连接速度慢
- 经常遇到连接超时
- 需要长时间保持 SSH 会话

---

## 🎨 界面优化

### 菜单结构调整

**旧版本：**

```
0) 一键优化
1-8) 单项优化
9) 验证配置
q) 退出
```

**新版本：**

```
0) 一键优化 (包含基础+可选环境)

[基础优化] 1-8
1) 换源加速
2) 账户安全配置
...
8) 系统清理

[环境配置] 9-14
9) Docker环境配置
10) Nginx配置与SSL证书
11) 安装常用工具
12) 配置自动备份
13) 配置系统监控告警
14) 优化SSH连接速度

[其他]
v) 验证配置
q) 退出脚本
```

### 一键优化流程优化

**执行顺序：**

1. 自动执行基础优化（1-8 项）
2. 询问是否配置 Docker 环境
3. 询问是否配置 Nginx
4. 询问是否安装常用工具
5. 询问是否配置自动备份
6. 询问是否配置系统监控
7. 询问是否优化 SSH 连接速度
8. 验证配置并生成报告

**特点：**

- 所有高级功能均为可选
- 用户可以选择性安装
- 更加灵活和人性化

---

## 📋 验证配置增强

### 新增验证项

**旧版本验证项：**

- 系统版本
- 内核版本
- 系统时间
- 内存使用
- 磁盘使用
- SSH 配置
- 防火墙状态
- Fail2Ban 状态
- BBR 状态

**新增验证项：**

- Docker 版本和运行状态
- Nginx 版本和运行状态
- 更详细的服务状态检查

---

## 📁 新增文件和配置

### 配置文件

```
/etc/docker/daemon.json               # Docker配置
/etc/nginx/nginx.conf                 # Nginx优化配置
/etc/nginx/ssl/                       # SSL证书目录
/etc/nginx/sites-available/           # Nginx站点配置
```

### 脚本文件

```
/usr/local/bin/auto_backup.sh         # 自动备份脚本
/usr/local/bin/system_monitor.sh      # 系统监控脚本
~/.acme.sh/                           # acme.sh证书工具
```

### 日志文件

```
/var/log/backup.log                   # 备份日志
/var/log/monitor.log                  # 监控日志
```

---

## 🚀 使用建议

### 新服务器推荐配置流程

**最小化安全配置（5 分钟）：**

```bash
选择 0 → 基础优化全部 y → 环境配置全部 n
```

适合：只需要基础安全的用户

**Web 服务器配置（10 分钟）：**

```bash
选择 0 → 基础优化全部 y → Docker n → Nginx y → 其他根据需要
```

适合：部署网站、博客的用户

**Docker 环境配置（10 分钟）：**

```bash
选择 0 → 基础优化全部 y → Docker y → Nginx n → 工具 y
```

适合：容器化部署的用户

**全栈生产配置（15 分钟）：**

```bash
选择 0 → 全部选择 y
```

适合：生产环境，需要完整功能

---

## ⚙️ 技术细节

### Docker 配置优化

```json
{
    "registry-mirrors": ["国内镜像源"],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "10m",
        "max-file": "3"
    },
    "default-address-pools": [...]
}
```

### Nginx 性能优化

```nginx
worker_processes auto;
worker_connections 4096;
gzip on;
gzip_comp_level 6;
ssl_protocols TLSv1.2 TLSv1.3;
```

### SSH 连接优化

```
UseDNS no
GSSAPIAuthentication no
TCPKeepAlive yes
ClientAliveInterval 60
ClientAliveCountMax 3
```

---

## 📊 完成后效果

### 系统状态

```
✅ 系统源：优化完成
✅ SSH端口：已修改（自定义）
✅ 防火墙：运行中（nftables/iptables）
✅ BBR：已启用
✅ Fail2Ban：运行中
✅ 时间同步：已配置
```

### 可选环境

```
✅ Docker：已安装 + 镜像加速
✅ Nginx：已安装 + 性能优化
✅ SSL证书：已配置 + 自动续期
✅ 自动备份：已配置 + 定时任务
✅ 系统监控：已配置 + 定时检查
✅ 常用工具：已安装
```

---

## 🎯 对比表格

| 功能        | v1.0 | v2.0 |
| ----------- | ---- | ---- |
| 基础优化    | ✅   | ✅   |
| Docker 环境 | ❌   | ✅   |
| Nginx + SSL | ❌   | ✅   |
| 常用工具    | ❌   | ✅   |
| 自动备份    | ❌   | ✅   |
| 系统监控    | ❌   | ✅   |
| SSH 优化    | ❌   | ✅   |
| 菜单分类    | ❌   | ✅   |
| 灵活选择    | 部分 | ✅   |

---

## 💡 升级建议

### 从 v1.0 升级

1. **备份现有配置**

   ```bash
   tar -czf ~/vps_config_backup_$(date +%Y%m%d).tar.gz \
       /etc/ssh/sshd_config \
       /etc/nftables.conf \
       /etc/nginx/ \
       /etc/docker/
   ```

2. **下载新版本**

   ```bash
   wget https://your-server.com/vps_optimize.sh
   chmod +x vps_optimize.sh
   ```

3. **运行新功能**
   - 选择 9-14 单独配置新功能
   - 或选择 0 重新完整配置

### 注意事项

- ⚠️ 新版本不会覆盖已有配置
- ⚠️ 可以选择性使用新功能
- ⚠️ 所有操作都会备份配置文件
- ⚠️ 建议先在测试环境验证

---

## 📞 获取支持

如有问题或建议，欢迎反馈！

**作者：** Kaiki  
**版本：** v2.0  
**更新：** 2025-10-19

---

## 🎉 致谢

感谢所有使用和反馈的用户！

如果这个脚本对你有帮助，欢迎：

- ⭐ Star
- 🔀 Fork
- 📢 分享给更多人
